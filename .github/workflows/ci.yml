name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Go format check
        run: |
          UNFORMATTED="$(gofmt -l .)"
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files are not gofmt'd:"
            echo "$UNFORMATTED"
            exit 1
          fi
      - name: Go test
        run: go test ./...
      - name: Go vet
        run: go vet ./...

  edgeadc-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login to EdgeADC registry (optional)
        if: ${{ secrets.EDGEADC_REGISTRY_USERNAME != '' && secrets.EDGEADC_REGISTRY_PASSWORD != '' }}
        env:
          EDGEADC_REGISTRY_HOST: ${{ secrets.EDGEADC_REGISTRY_HOST }}
          EDGEADC_REGISTRY_USERNAME: ${{ secrets.EDGEADC_REGISTRY_USERNAME }}
          EDGEADC_REGISTRY_PASSWORD: ${{ secrets.EDGEADC_REGISTRY_PASSWORD }}
        run: |
          EDGEADC_REGISTRY_HOST="${EDGEADC_REGISTRY_HOST:-docker.io}"
          echo "$EDGEADC_REGISTRY_PASSWORD" | docker login "$EDGEADC_REGISTRY_HOST" \
            -u "$EDGEADC_REGISTRY_USERNAME" --password-stdin
      - name: EdgeADC integration tests
        env:
          EDGEADC_IMAGE: ${{ secrets.EDGEADC_IMAGE }}
        run: ./scripts/test-edgeadc.sh
